# PROJECT KNOWLEDGE BASE

**Generated:** 2026-02-08
**Commit:** 6a882fe
**Branch:** main

## OVERVIEW

Chat UI for AI agents over WebSocket terminal sessions. Nuxt 4 + Vue 3.5 + TypeScript + Nuxt UI + SQLite (better-sqlite3). Parses ACP (Agent Client Protocol) JSON-RPC messages from spawned child processes.

## STRUCTURE

```
openagents/
├── app/                    # Frontend (Nuxt auto-imports everything here)
│   ├── components/         # ChatPanel, ChatSidebar, ConversationItem
│   ├── composables/        # useChat, useConversations, useStorage, useTerminalWs
│   ├── types/              # chat.ts (domain types), acp.ts (protocol types)
│   ├── utils/              # AcpConverter (stateful parser), messageConverter (singleton)
│   └── pages/index.vue     # Single route — dashboard with sidebar + chat panel
├── server/                 # Nitro backend (see server/AGENTS.md)
│   ├── api/storage/        # Generic CRUD REST endpoints for SQLite tables
│   ├── routes/ws/          # WebSocket handler for terminal process management
│   └── utils/              # DB connection, query builder, process manager
└── public/                 # Static assets (favicon, robots.txt)
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Chat message flow | `app/composables/useChat.ts` | Orchestrates WS → AcpConverter → messages |
| ACP protocol parsing | `app/utils/acpConverter.ts` | Stateful line-buffered JSON-RPC parser |
| ACP type definitions | `app/types/acp.ts` | JSON-RPC 2.0, session updates, type guards |
| WebSocket connection | `app/composables/useTerminalWs.ts` | Auto-connect/reconnect, spawn/stdin/kill |
| Conversation persistence | `app/composables/useConversations.ts` | localStorage-backed, Date serialization |
| DB storage client | `app/composables/useStorage.ts` | Wraps `/api/storage/[table]` endpoints |
| Server API endpoints | `server/api/storage/` | Dynamic table CRUD with schema inference |
| Terminal WebSocket | `server/routes/ws/terminal.ts` | Process spawn, stdio piping, lifecycle |
| Database setup | `server/utils/db/connection.ts` | SQLite singleton, WAL mode, `.data/storage.db` |
| SQL query building | `server/utils/db/query-builder.ts` | Parameterized queries, identifier validation |
| Process management | `server/utils/process-manager.ts` | spawn/kill/cleanup per WebSocket peer |

## DATA FLOW

```
User input → useChat.sendMessage()
  → useTerminalWs.sendStdin() → WebSocket → server/routes/ws/terminal.ts
  → child_process stdin

child_process stdout/stderr → WebSocket → useTerminalWs callbacks
  → AcpConverter.process() (line-buffered JSON-RPC parsing)
  → ChatMessage[] update → Vue reactivity → ChatPanel render
```

## CONVENTIONS

- **Package manager**: pnpm only. No npm/yarn/bun.
- **Composable exports**: Always `readonly()` refs to prevent external mutation
- **Composable lifecycle**: Auto-connect on `onMounted`, auto-cleanup on `onUnmounted`
- **Type safety**: Discriminated unions for message parts and ACP updates; type guards for parsing
- **Imports**: Use `~/types/...` and `~/utils/...` aliases (Nuxt auto-resolve)
- **Server imports**: Nitro auto-imports `defineEventHandler`, `getRouterParam`, `readBody`, `getQuery`, `createError`
- **Component props**: Use `defineProps<Props>()` with explicit interface
- **Component emits**: Use `defineEmits<{...}>()` with typed signatures
- **No layouts/middleware/plugins dirs** — intentionally minimal, single-page app

## ANTI-PATTERNS (THIS PROJECT)

- Do NOT edit `.nuxt/` — auto-generated by Nuxt
- Do NOT use `npm`, `yarn`, or `bun` — pnpm exclusively
- Do NOT use `error: any` without re-throwing as `createError()` in server handlers
- `AcpConverter` is stateful singleton — do NOT instantiate multiple instances
- Server DB queries use parameterized values — NEVER interpolate user input into SQL strings
- `_schema_registry` is a reserved table name — blocked in query-builder

## UNIQUE PATTERNS

- **ACP Protocol**: Agent Client Protocol over JSON-RPC 2.0 (newline-delimited). Reference: https://agentclientprotocol.com/overview/introduction
- **Dynamic tables**: SQLite tables auto-created on first POST via `inferSchema()` from row data
- **WebSocket terminal**: Server spawns child processes per WS peer, pipes stdio bidirectionally
- **Permission system**: ACP `permission_ask` updates flow through converter → UI can respond via JSON-RPC `permission/response`

## COMMANDS

```bash
pnpm install          # Install dependencies
pnpm dev              # Dev server → http://localhost:3000
pnpm build            # Production build
pnpm preview          # Preview production build
```

## NOTES

- No test framework configured — no vitest/jest/playwright
- No CI/CD pipeline — no GitHub Actions, Makefile, Docker
- WebSocket endpoint hardcoded in runtime config: `ws://localhost:3000/ws/terminal`
- Database stored at `.data/storage.db` (gitignored via `.data` in `.gitignore`)
- WebSocket reconnects automatically after 3s on disconnect
- `useConversations` stores data in browser localStorage (key: `chat_conversations`)
